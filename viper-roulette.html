<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VIPER ROULETTE - Protected</title>

<style>
body {
    background: linear-gradient(135deg, #000022, #001144);
    display: flex;
    flex-direction: column;
    align-items: center;
    font-family: Arial, sans-serif;
    margin: 0;
    padding: 120px;
    color: white;
    opacity: 0; /* hide until verified */
    transition: opacity 0.5s;
}

h1 {
    font-size: 2rem;
    font-weight: bold;
    text-shadow: 0 0 5px #00ffff, 0 0 15px #00ffea;
    margin-bottom: 30px;
}

/* ---- your existing CSS ---- */
.track-container { position: relative; width: 600px; height: 400px; margin-bottom: 20px; }
.num { width: 40px; height: 40px; display: flex; justify-content: center; align-items: center; font-weight: bold; position: absolute; border-radius: 50%; }
.red { background: #c62828; } .black { background: #111; } .green { background: #0fa23f; }
.num.neighbor { background: yellow !important; color: black; transform: scale(1.2); }
.num.center { background: #ff69b4 !important; color: black; transform: scale(1.3); }
.controls { display: flex; gap: 10px; margin-bottom: 20px; }
button { padding: 10px 20px; border: none; border-radius: 6px; font-weight: bold; cursor: pointer; }
#enterBtn { background: #0fa23f; color: white; }
#enterBtn:disabled { background: #555; cursor: not-allowed; opacity: 0.6; }
#undoBtn { background: #c62828; color: white; }
#resetBtn { background: #555; color: white; }
.result-input { width: 60px; height: 40px; background: #444; border: 1px solid #222; color: white; font-size: 16px; text-align: center; }
.history-container { width: 600px; display: flex; gap: 5px; margin-top: 10px; }
.history-num, .history-wl { width: 28px; height: 28px; border-radius: 4px; display: flex; justify-content: center; align-items: center; font-weight: bold; color: white; }
.history-num.red { background: #c62828; }
.history-num.black { background: #111; }
.history-num.green { background: #0fa23f; }
.history-wl.W { background: green; }
.history-wl.L { background: red; }

</style>
</head>

<body id="appBody">

<h1>VIPER ROULETTE</h1>

<div class="track-container" id="track"></div>

<div class="controls">
    <input type="number" id="resultInput" class="result-input" placeholder="0-36" min="0" max="36" required oninput="this.value=this.value.slice(0,2)">
    <button id="enterBtn" disabled>Enter</button>
    <button id="undoBtn">Undo</button>
    <button id="resetBtn">Reset</button>
</div>

<h3>Number History:</h3>
<div class="history-container" id="numberHistory"></div>

<h3>Win/Lose History:</h3>
<div class="history-container" id="wlHistory"></div>

<!-- Firebase -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore.js"></script>
<script src="firebase.js"></script> <!-- Your Firebase config -->

<script>
const db = firebase.firestore();
const auth = firebase.auth();
const APP_ID = "viper-roulette"; // match Firestore 'app' field

// ---- Check login & expiration ----
auth.onAuthStateChanged(async (user) => {
    if (!user) {
        window.location.href = "index.html"; // redirect if not logged in
        return;
    }

    // Check Firestore password document
    const docRef = db.collection("memberPasswords").doc(user.uid);
    const docSnap = await docRef.get();
    if (!docSnap.exists) {
        await auth.signOut();
        window.location.href = "index.html";
        return;
    }

    const data = docSnap.data();

    // Check if allowed app
    if (data.app !== APP_ID) {
        await auth.signOut();
        window.location.href = "index.html";
        return;
    }

    // Check expiration
    const now = new Date();
    if (data.expiresAt.toDate() < now) {
        alert("Your password has expired. Logging out.");
        await auth.signOut();
        window.location.href = "index.html";
        return;
    }

    // âœ… Everything ok, show app
    document.getElementById("appBody").style.opacity = 1;

    // Auto logout when expires
    const msUntilExpire = data.expiresAt.toDate() - now;
    setTimeout(async () => {
        alert("Your session expired. Logging out.");
        await auth.signOut();
        window.location.href = "index.html";
    }, msUntilExpire);
});

// ---- VIPER ROULETTE App Logic ----
window.addEventListener('DOMContentLoaded', () => {
    const trackContainer = document.getElementById('track');
    const resultInput = document.getElementById('resultInput');
    const enterBtn = document.getElementById('enterBtn');
    const wheelNumbers = [
        0,32,15,19,4,21,2,25,17,34,6,27,13,36,11,30,8,23,10,5,
        24,16,33,1,20,14,31,9,22,18,29,7,28,12,35,3,26
    ];
    const numbers = [];
    const centerX = 300;
    const centerY = 200;
    const radiusX = 250;
    const radiusY = 150;

    wheelNumbers.forEach((num, i) => {
        const angle = (i / wheelNumbers.length) * 2 * Math.PI + Math.PI;
        const x = centerX + radiusX * Math.cos(angle) - 20;
        const y = centerY + radiusY * Math.sin(angle) - 20;

        const div = document.createElement('div');
        div.classList.add('num'); div.textContent = num;
        if (num===0) div.classList.add('green');
        else if([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(num)) div.classList.add('red');
        else div.classList.add('black');
        div.style.left = `${x}px`; div.style.top = `${y}px`;
        trackContainer.appendChild(div); numbers.push(div);
    });

    const numberHistoryContainer = document.getElementById('numberHistory');
    const wlHistoryContainer = document.getElementById('wlHistory');
    let numberHistory = [], wlHistory = [], currentHighlight = [], firstEntry = true, undoStack = [];
    const maxHistory = 20, neighborCount = 9;

    function saveUndoState() { undoStack.push({ numberHistory:[...numberHistory], wlHistory:[...wlHistory], firstEntry, highlights:numbers.map(n=>n.className), currentHighlight:[...currentHighlight] }); }
    function restoreUndoState() { if(!undoStack.length) return; const s = undoStack.pop(); numberHistory=[...s.numberHistory]; wlHistory=[...s.wlHistory]; firstEntry=s.firstEntry; currentHighlight=[...s.currentHighlight]; numbers.forEach((n,i)=>n.className=s.highlights[i]); renderHistories(); }
    function generateHighlight() { numbers.forEach(n=>n.classList.remove('neighbor','center')); let centerIndex; do { centerIndex=Math.floor(Math.random()*numbers.length); } while(numbers[centerIndex].classList.contains('green')); numbers[centerIndex].classList.add('center'); for(let i=-neighborCount;i<=neighborCount;i++){ if(i===0) continue; const idx=(centerIndex+i+numbers.length)%numbers.length; numbers[idx].classList.add('neighbor'); } currentHighlight=numbers.filter(n=>n.classList.contains('neighbor')||n.classList.contains('center')).map(n=>Number(n.textContent)); }
    function renderHistories() { numberHistoryContainer.innerHTML=''; numberHistory.forEach(n=>{const d=document.createElement('div');d.classList.add('history-num');d.textContent=n;if(n===0)d.classList.add('green');else if([1,3,5,7,9,12,14,16,18,19,21,23,25,27,30,32,34,36].includes(n))d.classList.add('red');else d.classList.add('black'); numberHistoryContainer.appendChild(d); }); wlHistoryContainer.innerHTML=''; wlHistory.forEach(r=>{const d=document.createElement('div');d.classList.add('history-wl',r); d.textContent=r; wlHistoryContainer.appendChild(d); }); }

    resultInput.addEventListener('input',()=>{const v=resultInput.value; enterBtn.disabled=!(v!==''&&v>=0&&v<=36);});
    enterBtn.addEventListener('click',()=>{const value=Number(resultInput.value); if(isNaN(value)||value<0||value>36)return; saveUndoState(); numberHistory.push(value); if(numberHistory.length>maxHistory) numberHistory.shift(); if(!firstEntry){ wlHistory.push(currentHighlight.includes(value)?'W':'L'); if(wlHistory.length>maxHistory) wlHistory.shift();}else{ firstEntry=false;} generateHighlight(); renderHistories(); resultInput.value=''; enterBtn.disabled=true;});
    document.getElementById('undoBtn').addEventListener('click',restoreUndoState);
    document.getElementById('resetBtn').addEventListener('click',()=>{ numberHistory=[]; wlHistory=[]; currentHighlight=[]; firstEntry=true; undoStack=[]; numbers.forEach(n=>n.classList.remove('neighbor','center')); renderHistories(); resultInput.value=''; enterBtn.disabled=true; });
});
</script>
</body>
</html>
